
åœ¨[æ•°å­—ç­¾å](https://learnblockchain.cn/article/22613)ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å¯¹æ¶ˆæ¯è¿›è¡Œç­¾åå’ŒéªŒè¯ã€‚ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹å¤æ‚çš„ç»“æ„åŒ–æ•°æ®è¿›è¡Œç­¾åï¼Œæ¯”å¦‚è®¢å•ã€æŠ•ç¥¨ã€æˆæƒç­‰ã€‚

EIP-712 æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œç”Ÿã€‚å®ƒå®šä¹‰äº†ä¸€ç§å¯¹ç»“æ„åŒ–æ•°æ®è¿›è¡Œç­¾åçš„æ ‡å‡†æ–¹æ³•ï¼Œä½¿å¾—ï¼š
- ç­¾åæ•°æ®åœ¨é’±åŒ…ç•Œé¢ä¸­å¯è¯»æ€§æ›´å¥½ï¼ˆç”¨æˆ·èƒ½çœ‹æ‡‚è‡ªå·±åœ¨ç­¾ä»€ä¹ˆï¼‰
- ç­¾åæ›´å®‰å…¨ï¼ˆé˜²æ­¢ç­¾åè¢«ç”¨äºå…¶ä»–ç”¨é€”ï¼‰
- éªŒè¯æ›´æ ‡å‡†åŒ–ï¼ˆé“¾ä¸ŠéªŒè¯æœ‰ç»Ÿä¸€çš„è§„èŒƒï¼‰

## EIP-712 vs åŸºç¡€ç­¾å

è®©æˆ‘ä»¬å…ˆå¯¹æ¯”ä¸€ä¸‹ EIP-712 ä¸åŸºç¡€çš„æ¶ˆæ¯ç­¾åæœ‰ä»€ä¹ˆä¸åŒï¼š

### åŸºç¡€ç­¾åï¼ˆeth_sign / personal_signï¼‰

åœ¨[æ•°å­—ç­¾å](https://learnblockchain.cn/article/22613)ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç®€å•æ¶ˆæ¯ç­¾åï¼š

```solidity
// ç­¾åçš„å†…å®¹
bytes32 messageHash = keccak256(abi.encodePacked("Hello, Ethereum!"));
bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
    "\x19Ethereum Signed Message:\n32",
    messageHash
));
```

**é—®é¢˜**ï¼š
- ç”¨æˆ·åªèƒ½çœ‹åˆ°ä¸€ä¸²å“ˆå¸Œå€¼æˆ–ç®€å•æ–‡æœ¬ï¼Œä¸çŸ¥é“å…·ä½“åœ¨ç­¾ä»€ä¹ˆ
- æ²¡æœ‰æ˜ç¡®çš„æ•°æ®ç»“æ„ï¼Œå®¹æ˜“æ··æ·†
- ç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå“ªä¸ªåˆçº¦ã€å“ªæ¡é“¾ï¼‰

### EIP-712 ç»“æ„åŒ–ç­¾åï¼ˆeth_signTypedDataï¼‰

EIP-712 æ”¹è¿›äº†è¿™ä¸ªè¿‡ç¨‹ï¼š

```solidity
// ç­¾åçš„å†…å®¹
struct Order {
    address from;
    address to;
    uint256 amount;
}

// åŒ…å«åŸŸä¿¡æ¯ï¼ˆåˆçº¦åœ°å€ã€é“¾IDç­‰ï¼‰
bytes32 digest = keccak256(abi.encodePacked(
    "\x19\x01",
    domainSeparator,  // åŒ…å«åˆçº¦åœ°å€ã€é“¾IDç­‰ä¿¡æ¯
    structHash        // ç»“æ„åŒ–æ•°æ®çš„å“ˆå¸Œ
));
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·åœ¨é’±åŒ…ä¸­èƒ½çœ‹åˆ°å…·ä½“çš„æ•°æ®ç»“æ„å’Œå€¼
- âœ… åŒ…å«åŸŸä¿¡æ¯ï¼ˆdomainï¼‰ï¼Œé˜²æ­¢è·¨é“¾/è·¨åˆçº¦é‡æ”¾
- âœ… æ ‡å‡†åŒ–çš„æ ¼å¼ï¼Œé’±åŒ…èƒ½æ›´å¥½åœ°å±•ç¤º

![eth_sign](https://img.learnblockchain.cn/pics/eth_sign.png)

`eth_sign`ï¼ˆä¸Šï¼‰ å’Œ `eth_signTypedData`ï¼ˆä¸‹ï¼‰ ç­¾åå¯¹æ¯”

![eth_signTypedData](https://img.learnblockchain.cn/pics/eth_signTypedData.png)

## ç»“æ„åŒ–æ•°æ®ç­¾åæµç¨‹

EIP-712 æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„æ–¹æ³•æ¥ç­¾åç»“æ„åŒ–æ•°æ®ï¼š

`digest = keccak256("\x19\x01" â€– domainSeparator â€– hashStruct(message))`

è¿™åŒ…æ‹¬å‡ ä¸ªå…³é”®æ­¥éª¤ï¼Œè®©æˆ‘ä»¬é€ä¸€äº†è§£ï¼š

1. `\x19\x01`:
    è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„å­—èŠ‚ï¼Œç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„ç­¾åä»¥é˜²å†²çªã€‚`0x19` è¡¨ç¤ºæ˜¯ä»¥å¤ªåŠçš„ç­¾åæ¶ˆæ¯ï¼Œ`0x01` åˆ™æ˜¯ç‰¹å®šäº EIP-712 çš„æ ‡è¯†ã€‚
    
    æ›´å¤šç­¾åæ•°æ®æ ‡å‡†å‚è€ƒ [EIP-191](https://learnblockchain.cn/docs/eips/EIPS/eip-191/)

2. åˆ›å»ºåŸŸåˆ†éš”ç¬¦ (EIP712Domain Separator)

    åŸŸåˆ†éš”ç¬¦å®šä¹‰äº†ç­¾åæ¶ˆæ¯çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¾‹å¦‚åˆçº¦çš„åç§°ã€ç‰ˆæœ¬å·ã€é“¾ ID å’ŒéªŒè¯åˆçº¦åœ°å€ç­‰ã€‚è¿™å¯ä»¥å¸®åŠ©ç¡®ä¿ç­¾ååœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­è¢«éªŒè¯ï¼Œé¿å…åœ¨å¤šä¸ªåº”ç”¨é—´çš„ç­¾åå†²çªï¼Œå¹¶å¸®åŠ©é˜²æ­¢é‡æ”¾æ”»å‡»ã€‚

    åŸŸåˆ†éš”ç¬¦**å¯ä»¥**åŒ…å«ä»¥ä¸‹å­—æ®µï¼Œå…·ä½“å–å†³äºåè®®è®¾è®¡è€…çš„éœ€æ±‚ï¼š
    - `string name`ï¼šåç§°ï¼Œé€šå¸¸æ˜¯ DApp æˆ–åè®®çš„åç§°
    - `string version`ï¼šå½“å‰ç‰ˆæœ¬å·ï¼Œä¸åŒç‰ˆæœ¬çš„ç­¾åå¯èƒ½ä¸å…¼å®¹
    - `uint256 chainId`ï¼šé“¾ IDï¼Œè¡¨æ˜åˆçº¦æ‰€åœ¨çš„åŒºå—é“¾çš„é“¾IDï¼Œä»¥ç¡®ä¿ç­¾åä¸ä¼šåœ¨ä¸åŒçš„é“¾ä¹‹é—´è¢«é‡ç”¨
    - `address verifyingContract`ï¼šå°†ç”¨æ¥éªŒè¯ç­¾åçš„æ™ºèƒ½åˆçº¦åœ°å€
    - `bytes32 salt`ï¼šæä¾›äº†é¢å¤–çš„å®‰å…¨éšæœºæ€§

    ç¤ºä¾‹ä»£ç ï¼š
    ```
    bytes32 domainSeparator = keccak256(
        abi.encode(
            keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
            keccak256(bytes(name)),
            keccak256(bytes(version)),
            chainId,
            verifyingContract
        )
    );
    ```

3. åˆ›å»ºç»“æ„åŒ–æ•°æ®çš„å“ˆå¸Œ

    å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º Order çš„ç»“æ„ï¼Œå®ƒåŒ…æ‹¬ä»¥ä¸‹å­—æ®µï¼š
    ```
    struct Order {
        address from;
        address to;
        uint256 amount;
    }
    ```

    é¦–å…ˆå®šä¹‰å¹¶åˆ›å»ºè¯¥ç»“æ„çš„ç±»å‹å“ˆå¸Œï¼š

    `string constant TYPEHASH = keccak256("Order(address from,address to,uint256 amount)");`

    ç„¶åå°†ç±»å‹å“ˆå¸Œä¸å®é™…æ•°æ®å€¼ä¸€èµ·ç¼–ç å¹¶å“ˆå¸Œï¼š
    ```
    bytes32 structHash = keccak256(
        abi.encode(
            TYPEHASH,
            order.from,
            order.to,
            order.amount
        )
    );
    ```

4. ç”Ÿæˆæœ€ç»ˆç­¾åå“ˆå¸Œ

    ç»“åˆåŸŸåˆ†éš”ç¬¦å’Œç»“æ„åŒ–æ•°æ®å“ˆå¸Œï¼Œåˆ›å»ºæœ€ç»ˆçš„ç­¾åå“ˆå¸Œï¼š
    ```
    bytes32 digest = keccak256(
        abi.encodePacked(
            "\x19\x01",
            domainSeparator,
            structHash
        )
    );
    ```

## åˆçº¦ä¸­éªŒè¯ç­¾å

åˆçº¦ä¸­å¯ä»¥ä½¿ç”¨ `ecrecover` å‡½æ•°æ¥éªŒè¯ç­¾åï¼Œç¡®ä¿ç­¾åè€…çš„åœ°å€ä¸é¢„æœŸç›¸åŒ¹é…ï¼Œä»è€ŒéªŒè¯ç­¾åçš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚

ç­¾åéªŒè¯æ­¥éª¤å¦‚ä¸‹ï¼š

- æ„é€ æ¶ˆæ¯å“ˆå¸Œï¼šä¸ºäº†éªŒè¯ç­¾åï¼Œé¦–å…ˆéœ€è¦é‡å»ºç­¾åæ—¶æ‰€ç”¨çš„ç›¸åŒæ¶ˆæ¯å“ˆå¸Œã€‚è¿™é€šå¸¸æ¶‰åŠå°†åŸå§‹å‚æ•°æŒ‰ç…§æŒ‡å®šæ ¼å¼è¿›è¡Œåºåˆ—åŒ–ä¸å“ˆå¸Œå¤„ç†ã€‚
- ä½¿ç”¨ `ecrecover` å‡½æ•°æ¢å¤ç­¾åè€…çš„åœ°å€ï¼šSolidity è¯­è¨€æä¾›çš„ `ecrecover` å‡½æ•°èƒ½å¤Ÿé€šè¿‡ç»™å®šçš„æ¶ˆæ¯å“ˆå¸Œå€¼åŠç­¾åï¼ˆåŒ…æ‹¬`r`, `s`, `v`ä¸‰ä¸ªå‚æ•°ï¼‰æ¥ç¡®å®šç­¾åè€…çš„åœ°å€ã€‚
- æ ¡éªŒæ¢å¤çš„åœ°å€ä¸é¢„æœŸåœ°å€æ˜¯å¦åŒ¹é…ï¼šé€šè¿‡æ¯”è¾ƒ `ecrecover` å‡½æ•°è¾“å‡ºçš„åœ°å€ä¸äº‹å…ˆå®šä¹‰çš„æœŸæœ›åœ°å€ï¼Œç¡®ä¿æ¢å¤å‡ºçš„åœ°å€ä¸é¢„æœŸä¸€è‡´ï¼Œä»è€ŒéªŒè¯ç­¾åè€…çš„èº«ä»½ã€‚è¿™ä¸€æ­¥æ˜¯ç¡®è®¤äº¤æ˜“å‘èµ·è€…èº«ä»½åˆæ³•æ€§çš„å…³é”®ç¯èŠ‚ã€‚

## å®Œæ•´åˆçº¦ç¤ºä¾‹

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç»™å‡ºä¸€ä¸ªç¤ºä¾‹[æ™ºèƒ½åˆçº¦](https://learnblockchain.cn/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6)ï¼Œå±•ç¤ºå¦‚ä½•åœ¨åˆçº¦ä¸­é›†æˆ EIP-712 ç­¾åæœºåˆ¶ã€‚è¿™ä¸ªåˆçº¦å°†åŒ…æ‹¬åˆ›å»º EIP-712 åŸŸåˆ†éš”ç¬¦ï¼Œç»“æ„åŒ–æ•°æ®çš„å“ˆå¸Œï¼Œä»¥åŠéªŒè¯ç­¾åçš„åŠŸèƒ½ã€‚

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EIP712Example {
    struct Order {
        address from;
        address to;
        uint256 amount;
    }

    bytes32 constant ORDER_TYPEHASH =
        keccak256(
            "Order(address from,address to,uint256 amount)"
        );

    bytes32 public DOMAIN_SEPARATOR;

    constructor(string memory name, string memory version) {
        DOMAIN_SEPARATOR = keccak256(
            abi.encode(
                keccak256(
                    "EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"
                ),
                keccak256(bytes(name)),
                keccak256(bytes(version)),
                block.chainid,
                address(this)
            )
        );
    }

    function _hashOrder(Order memory order) internal view returns (bytes32) {
        return keccak256(
            abi.encode(
                ORDER_TYPEHASH,
                order.from,
                order.to,
                order.amount
            )
        );
    }

    function _hashTypedData(bytes32 structHash) internal view returns (bytes32) {
        return keccak256(
            abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, structHash)
        );
    }

    function verify(
        Order memory order,
        bytes memory signature
    ) external view returns (bool) {
        uint8 v;
        bytes32 r;
        bytes32 s;

        if (signature.length != 65) {
            return false;
        }

        assembly {
            r := mload(add(signature, 32))
            s := mload(add(signature, 64))
            v := byte(0, mload(add(signature, 96)))
        }

        bytes32 structHash = _hashOrder(order);
        bytes32 digest = _hashTypedData(structHash);
        address signer = ecrecover(digest, v, r, s);

        return signer == order.from;
    }
}
```

## åœ¨å®¢æˆ·ç«¯è¿›è¡Œç­¾å

### ä½¿ç”¨ ethers.js

#### ethers v6 (æ¨è)

```javascript
import { BrowserProvider } from 'ethers';

const domain = {
    name: 'MyOrderApp',
    version: '1',
    chainId: 10, // ä½¿ç”¨å…·ä½“çš„Chain ID
    verifyingContract: '0x2d04c136Ebb705bd2cE858e28BeFe258C1Ec51F7', // åˆçº¦å…·ä½“çš„åˆçº¦åœ°å€
};

// ç±»å‹çš„å®šä¹‰
const types = {
    Order: [
        { name: 'from', type: 'address' },
        { name: 'to', type: 'address' },
        { name: 'amount', type: 'uint256' }
    ]
};

// åˆ›å»ºä¸€ä¸ªç¬¦åˆ Order ç»“æ„çš„æ¶ˆæ¯å®ä¾‹
const order = {
    from: '0xfrom...',
    to: '0xto...',
    amount: 1000
};

async function requestSignature() {
    // ä½¿ç”¨ ethers v6 è¿æ¥åˆ°ä»¥å¤ªåŠé’±åŒ…
    const provider = new BrowserProvider(window.ethereum);

    await provider.send('eth_requestAccounts', []); // è¯·æ±‚ç”¨æˆ·æˆæƒ
    const signer = await provider.getSigner();

    // å‘èµ·ç­¾å
    const signature = await signer.signTypedData(domain, types, order);
    console.log('Signature:', signature);
}
```

#### ethers v5 (æ—§ç‰ˆæœ¬)

```javascript
const domain = {
    name: 'MyOrderApp',
    version: '1',
    chainId: 10, // ä½¿ç”¨å…·ä½“çš„Chain ID
    verifyingContract: '0x2d04c136Ebb705bd2cE858e28BeFe258C1Ec51F7', // åˆçº¦å…·ä½“çš„åˆçº¦åœ°å€
};

// ç±»å‹çš„å®šä¹‰
const types = {
    Order: [
        { name: 'from', type: 'address' },
        { name: 'to', type: 'address' },
        { name: 'amount', type: 'uint256' }
    ]
};

// åˆ›å»ºä¸€ä¸ªç¬¦åˆ Order ç»“æ„çš„æ¶ˆæ¯å®ä¾‹
const order = {
    from: '0xfrom...',
    to: '0xto...',
    amount: 1000
};

async function requestSignature() {
    // ä½¿ç”¨ ethers è¿æ¥åˆ°ä»¥å¤ªåŠé’±åŒ…
    const provider = new ethers.providers.Web3Provider(window.ethereum);

    await provider.send('eth_requestAccounts', []); // è¯·æ±‚ç”¨æˆ·æˆæƒ
    const signer = provider.getSigner();

    // å‘èµ·ç­¾å
    const signature = await signer._signTypedData(domain, types, order);
    console.log('Signature:', signature);
}
```

### ä½¿ç”¨ viem

```javascript
import { createWalletClient, custom } from 'viem'
import { mainnet } from 'viem/chains'

const domain = {
    name: 'MyOrderApp',
    version: '1',
    chainId: 10,
    verifyingContract: '0x2d04c136Ebb705bd2cE858e28BeFe258C1Ec51F7',
}

const types = {
    Order: [
        { name: 'from', type: 'address' },
        { name: 'to', type: 'address' },
        { name: 'amount', type: 'uint256' }
    ]
}

const order = {
    from: '0xfrom...',
    to: '0xto...',
    amount: 1000n  // æ³¨æ„ï¼šviem ä½¿ç”¨ bigint
}

async function requestSignature() {
    const client = createWalletClient({
        chain: mainnet,
        transport: custom(window.ethereum)
    })

    const [account] = await client.requestAddresses()

    // å‘èµ·ç­¾å
    const signature = await client.signTypedData({
        account,
        domain,
        types,
        primaryType: 'Order',
        message: order,
    })

    console.log('Signature:', signature)
}
```

## å‚è€ƒ
- [æ•°å­—ç­¾å](https://learnblockchain.cn/article/22613) - åŸºç¡€ç­¾åæœºåˆ¶
- [EIP-712 ç±»å‹åŒ–ç»“æ„åŒ–æ•°æ®æ•£åˆ—å’Œç­¾å](https://learnblockchain.cn/docs/eips/EIPS/eip-712/)
- [EIP-191 ç­¾åæ•°æ®æ ‡å‡†](https://learnblockchain.cn/docs/eips/EIPS/eip-191/)

## æ€»ç»“

EIP-712 æ˜¯[åŸºç¡€æ¶ˆæ¯ç­¾å](https://learnblockchain.cn/article/22613)çš„è¿›é˜¶ç‰ˆæœ¬ï¼Œå®ƒä¸ºç»“æ„åŒ–æ•°æ®ç­¾åæä¾›äº†æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸ“Š **å¯è¯»æ€§**ï¼šç”¨æˆ·èƒ½åœ¨[é’±åŒ…](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)ä¸­çœ‹åˆ°å…·ä½“çš„æ•°æ®ç»“æ„å’Œå€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸²å“ˆå¸Œ
- ğŸ”’ **å®‰å…¨æ€§**ï¼šé€šè¿‡åŸŸåˆ†éš”ç¬¦ï¼ˆDomain Separatorï¼‰é˜²æ­¢è·¨é“¾ã€è·¨åˆçº¦çš„ç­¾åé‡æ”¾æ”»å‡»
- ğŸ¯ **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„ç­¾åæ ¼å¼ï¼Œ[é’±åŒ…](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)å’Œ [DApp](https://learnblockchain.cn/tags/DApp) éƒ½èƒ½æ­£ç¡®è§£æå’Œå±•ç¤º

**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ EIP-712**ï¼š
- âœ… éœ€è¦ç­¾åå¤æ‚çš„æ•°æ®ç»“æ„ï¼ˆè®¢å•ã€æŠ•ç¥¨ã€è®¸å¯ç­‰ï¼‰
- âœ… éœ€è¦è®©ç”¨æˆ·æ¸…æ¥šåœ°çœ‹åˆ°ç­¾åå†…å®¹
- âœ… éœ€è¦é˜²æ­¢è·¨åˆçº¦/è·¨é“¾çš„ç­¾åé‡æ”¾

**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨åŸºç¡€ç­¾å**ï¼š
- ç®€å•çš„å­—ç¬¦ä¸²æ¶ˆæ¯ç­¾åï¼ˆå¦‚ç™»å½•éªŒè¯ï¼‰
- ä¸éœ€è¦å¤æ‚æ•°æ®ç»“æ„çš„åœºæ™¯

é€šè¿‡ EIP-712ï¼Œå¼€å‘è€…å¯ä»¥å®æ–½æ›´å®‰å…¨ã€æ›´é€æ˜çš„ç­¾åæ–¹æ¡ˆï¼Œå¤§å¹…æå‡ç”¨æˆ·ä½“éªŒå’Œåˆçº¦å®‰å…¨æ€§ã€‚